<div class="show-content-wrapper">
  <div class="game-infos-wrapper d-flex justify-content-between">
    <div class="game-infos">
      <h3><%= @game.name %></h3>
      <% if @game.reservations.where(active: true).count < 6 %>
        <div class="d-flex justify-content-end align-items-end">
          <% if !@game.users.include?(current_user) %>
            <%= simple_form_for [@game, @reservation] do |f|%>
              <div><%= f.submit 'Join this Game !', class: "btn btn-flat"%></div>
            <% end %>
          <% else %>
            <% reservation_idd = Reservation.all.where(user_id: current_user.id, game_id: @game.id).to_a[0].id %>
            <%# <%= link_to "Leave Game", game_reservation_path(@game, reservation_idd), method: :delete, class: "btn btn-danger" %>
            <% if @game.reservations.where(user_id: current_user.id)[0].active %>
              <%= link_to "Leave the Game", game_reservation_path(@game, reservation_idd), method: :put, class: "btn btn-leave" %>
            <% else %>
              <%= link_to "Re-join the Game", game_reservation_path(@game, reservation_idd), method: :put, class: "btn btn-flat" %>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="game-infos-right">
      <div>
        <h6 class="mb-3"><%= @game.sb_amount %>‚Ç¨/<%= @game.sb_amount %>‚Ç¨/<%= @game.max_bet_amount %>‚Ç¨</h6>
        <% if @game.hands.count == 0 || @game.hands.count == 1 %>
          <p><%= @game.hands.count %> hand played</p>
        <% else %>
          <p><%= @game.hands.count %> hands played</p>
        <% end %>
      </div>
      <% if @game.hand_limit == 100000 || @game.hand_limit == nil  %>
        <%= link_to "Last 10 hands", game_path(@game), method: :put, class: "btn btn-leave", :data => {:confirm => 'Are you sure that you want to stop the game in 10 hands ?'} %>
      <% else %>
        <% if @game.hand_limit - @game.hands.count > 1 %>
          <span>üö® <%= @game.hand_limit - @game.hands.count %> hands left üö®</span>
        <% elsif @game.hand_limit - @game.hands.count == 1 && @game.hands.where(game: @game).last.river_cards.count == 0 %>
          <span>üö® LAST HAND üö®</span>
        <% else %>
          <span>‚õîÔ∏è Game over ! ‚õîÔ∏è</span>
        <% end %>
      <% end %>
    </div>
  </div>

  <% player_position = 1 %>
  <div class="poker-table mb-5">
    <% @active_players.each do |user| %>
      <% if @active_players.include?(@user)  %>
        <% player_position = @active_players.find_index(user) - @active_players.find_index(@user) %>
        <% if player_position < 0 %>
          <% player_position = @active_players.count - @active_players.find_index(@user) + @active_players.find_index(user) %>
        <% end %>
      <% end %>
      <% if @active_players.count == 2 && player_position == 1 %>
        <% player_position == 3 %>
      <% elsif @active_players.count == 3 && player_position == 1  %>
        <% player_position == 2 %>
      <% elsif @active_players.count == 3 && player_position == 2  %>
        <% player_position == 4 %>
      <% elsif @active_players.count == 4 && player_position == 1  %>
        <% player_position == 2 %>
      <% elsif @active_players.count == 4 && player_position == 2  %>
        <% player_position == 3 %>
      <% elsif @active_players.count == 4 && player_position == 3  %>
        <% player_position == 4 %>
      <% end %>
      <div class="player-infos position-<%=player_position%>">
        <div class="player-cards-wrapper">
          <% if (user == @user && @in_hand_players.include?(user)) %>
            <div class="text-center d-flex justify-content-center">
              <%= image_tag "#{@current_hand.user_cards.where(user: @user)[0].deck_card.url}", class: "user-cards-1 #{'card-1-deviation' if @current_hand.user_cards.where(user: @user).count == 3} #{'card-1-deviation-o4' if @current_hand.user_cards.where(user: @user).count == 4}" %>
              <%= image_tag "#{@current_hand.user_cards.where(user: @user)[1].deck_card.url}", class: "user-cards-2 #{'card-2-deviation-o4' if @current_hand.user_cards.where(user: @user).count == 4}" %>
              <% if @current_hand.user_cards.where(user: @user).count == 3 %>
                <%= image_tag "#{@current_hand.user_cards.where(user: @user)[2].deck_card.url}", class: "user-cards-3" %>
              <% end %>
              <% if @current_hand.user_cards.where(user: @user).count == 4 %>
                <%= image_tag "#{@current_hand.user_cards.where(user: @user)[2].deck_card.url}", class: "user-cards-3 #{'card-3-deviation-o4' if @current_hand.user_cards.where(user: @user).count == 4}" %>
                <%= image_tag "#{@current_hand.user_cards.where(user: @user)[3].deck_card.url}", class: "user-cards-4" %>
              <% end %>
            </div>
          <% elsif @in_hand_players.include?(user) %>
            <% if @current_hand.better == nil && (@in_hand_players_card_count == @in_hand_players.count * 2 || @in_hand_players_card_count == @in_hand_players.count * 4 ) %>
              <div class="text-center d-flex justify-content-center">
                <%= image_tag "#{@current_hand.user_cards.where(user: user)[0].deck_card.url}", class: "user-cards-1 #{'card-1-deviation' if @current_hand.user_cards.where(user: user).count == 3} #{'card-1-deviation-o4' if @current_hand.user_cards.where(user: user).count == 4}" %>
                <%= image_tag "#{@current_hand.user_cards.where(user: user)[1].deck_card.url}", class: "user-cards-2 #{'card-2-deviation-o4' if @current_hand.user_cards.where(user: user).count == 4}" %>
                <% if @current_hand.user_cards.where(user: user).count == 3 %>
                  <%= image_tag "#{@current_hand.user_cards.where(user: user)[2].deck_card.url}", class: "user-cards-3" %>
                <% end %>
                <% if @current_hand.user_cards.where(user: user).count == 4 %>
                  <%= image_tag "#{@current_hand.user_cards.where(user: user)[2].deck_card.url}", class: "user-cards-3 #{'card-3-deviation-o4' if @current_hand.user_cards.where(user: user).count == 4}" %>
                  <%= image_tag "#{@current_hand.user_cards.where(user: user)[3].deck_card.url}", class: "user-cards-4" %>
                <% end %>
              </div>
            <% else %>
              <div class="text-center d-flex justify-content-center">
                <%= image_tag "#{@current_hand.user_cards.where(user: user)[0].deck_card.url}", class: "user-cards-1 #{'card-1-deviation' if @current_hand.user_cards.where(user: user).count == 3} #{'card-1-deviation-o4' if @current_hand.user_cards.where(user: user).count == 4}" %>
                <%= image_tag "#{@current_hand.user_cards.where(user: user)[1].deck_card.url}", class: "user-cards-2 #{'card-2-deviation-o4' if @current_hand.user_cards.where(user: user).count == 4}" %>
                <% if @current_hand.user_cards.where(user: user).count == 3 %>
                  <%= image_tag "#{@current_hand.user_cards.where(user: user)[2].deck_card.url}", class: "user-cards-3" %>
                <% end %>
                <% if @current_hand.user_cards.where(user: user).count == 4 %>
                  <%= image_tag "#{@current_hand.user_cards.where(user: user)[2].deck_card.url}", class: "user-cards-3 #{'card-3-deviation-o4' if @current_hand.user_cards.where(user: user).count == 4}" %>
                  <%= image_tag "#{@current_hand.user_cards.where(user: user)[3].deck_card.url}", class: "user-cards-4" %>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <div class="text-center d-flex justify-content-center">
              <div class="transparent"></div>
              <div class="transparent"></div>
            </div>
          <% end %>
        </div>
        <% if  UserHand.where(user: user, hand: @current_hand)[0] && ((@in_hand_players_card_count == @in_hand_players.count * 2) || (@in_hand_players_card_count == @in_hand_players.count * 4)) %>
          <div class="percentage <%= 'odds-deviation' if @current_hand.user_cards.where(user: user).count == 4 %>" id="<%= 'current-winner' if @current_winners && @current_winners.include?(user) %>">
            <%= UserHand.where(user: user, hand: @current_hand)[0].odds %>
          </div>
        <% end %>
        <div class="player-card <%= 'current-better' if @current_hand && @current_hand.better == user && @current_hand.flop_cards.count == 0 %> d-flex justify-content-around align-items-center">
          <div class= "user-infos d-flex flex-column flex-grow-1">
            <div class="user-pseudo text-center mb-0"><%= user.pseudo %></div>
            <div class="d-flex justify-content-center align-items-center" >
              <p class="mb-0"><%= @game.reservations.where(user: user)[0].score  %>‚Ç¨</p>
            </div>
          </div>
          <% if @current_hand && @current_hand.button == user %>
            <div class="button d-flex justify-content-center align-items-center">
                <%= image_tag "button_spade.png", class: "button-spade" %>
            </div>
          <% end %>
          <% if @current_hand && !@current_hand.bets.where(user: user).empty? %>
            <div class="bet-amount d-flex justify-content-center align-items-center">
              <%= image_tag "casino-chip.png", class: "casino-chip" %>
              <p><%= @current_hand.bets.where(user: user).last.amount %>‚Ç¨</p>
            </div>
          <% end %>
          <div class="picture-wrapper">
            <% if user.photo.attached? %>
              <%= cl_image_tag user.photo.key, crop: :thumb, class: "in-game-picture" %>
            <% else %>
              <%= image_tag "sam_photo.png", class: "in-game-picture" %>
            <% end %>
          </div>
        </div>
        <% player_position += 1 %>
        <% if (@in_hand_players.include?(user) && @current_hand.flop_cards.count == 3) && ((@in_hand_players_card_count == @in_hand_players.count * 2) || (@in_hand_players_card_count == @in_hand_players.count * 4))  %>
          <div class="d-flex justify-content-center">
            <p class="hand-strength"><%= UserHand.where(user: user, hand: @current_hand)[0].rank %></p>
          </div>
        <% else %>
          <div class="d-flex justify-content-center">
          <p class="empty-hand-strength">
          </p>
          </div>
        <% end %>
      </div>
    <% end %>
    <div>
      <% if @active_players.count > 0 %>
        <div class="inner-table">
          <div>
            <p class="pot">
              Pot: <%= @pot %>‚Ç¨
              <span class="remainder">
              <% if @last_hand_remainder %>
                (<%= @last_hand_remainder %>‚Ç¨ bonus)
              <% end %>
              </span>
            </p>
          </div>
          <div class="board-cards">
            <% if @current_hand %>
              <% @current_hand.flop_cards.each do |card| %>
                  <%= image_tag "#{card.deck_card.url}", class: "board-card" %>
              <% end %>
              <% @current_hand.turn_cards.each do |card| %>
                  <%= image_tag "#{card.deck_card.url}", class: "board-card" %>
              <% end %>
              <% if @current_hand.turn_cards.empty? %>
                <div class="empty-card"></div>
              <% end %>
              <% @current_hand.river_cards.each do |card| %>
                  <%= image_tag "#{card.deck_card.url}", class: "board-card" %>
              <% end %>
              <% if @current_hand.river_cards.empty? %>
                <div class="empty-card"></div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
      <% if @game.users.include?(current_user) %>
        <div class="buttons d-flex justify-content-center">
          <% if @game.hand_limit - 1 > @game.hands.count %>
            <%= simple_form_for [@game, @hand] do |f| %>
              <%= f.hidden_field :name, :value => "Texas" %>
              <%= f.submit "Texas", class: "dealing-button" %>
            <% end %>
            <%= simple_form_for [@game, @hand] do |f| %>
              <%= f.hidden_field :name, :value => "Pineapple" %>
              <%= f.submit "Pineapple", class: "dealing-button" %>
            <% end %>
            <%= simple_form_for [@game, @hand] do |f| %>
              <%= f.hidden_field :name, :value => "Omaha 4" %>
              <%= f.submit "Omaha 4", class: "dealing-button" %>
            <% end %>
          <% end %>
          <% if @current_hand && @game.users.include?(current_user) %>
            <% if @current_hand.flop_cards.count == 0 %>
              <%= simple_form_for [@game, @current_hand, @flop_card] do |f| %>
                <%= f.submit "Deal flop", class: "dealing-button" %>
              <% end %>
            <% elsif @current_hand.flop_cards.count == 3 && @current_hand.turn_cards.count == 0  %>
              <%= simple_form_for [@game, @current_hand, @turn_card] do |f| %>
                <%= f.submit "Deal turn", class: "dealing-button" %>
              <% end %>
            <% elsif @current_hand.turn_cards.count == 1 && @current_hand.river_cards.count == 0 %>
              <%= simple_form_for [@game, @current_hand, @river_card] do |f| %>
                <%= f.submit "Deal river", class: "dealing-button" %>
              <% end %>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <% if @current_hand %>
    <% if @current_hand.flop_cards.count == 3 && @current_hand.user_cards.where(user: @user).count == 3 %>
      <div class="delete-cards-wrapper d-flex">
        <%= link_to "Delete #{@current_user_card_1.deck_card.name}",
                game_hand_user_card_path(@current_hand, @current_user_card_1),
                method: :delete, class: "btn-delete" %>
        <%= link_to "Delete #{@current_user_card_2.deck_card.name}",
                game_hand_user_card_path(@current_hand, @current_user_card_2),
                method: :delete, class: "btn-delete" %>
        <%= link_to "Delete #{@current_user_card_3.deck_card.name}",
                game_hand_user_card_path(@current_hand, @current_user_card_3),
                method: :delete, class: "btn-delete" %>
      </div>
    <% end %>
  <% end %>

  <% if @current_hand && @user == @current_hand.better && @current_hand.flop_cards.count == 0 %>
    <div class="betting-wrapper d-flex">
      <% if !@user_last_bet || @user_last_bet.amount < @hand_last_bet.amount %>
        <div class="fold">
          <%= link_to "Fold", game_hand_user_hand_path(@game, @current_hand, @current_player_user_hand), method: :put, class: "action-button" %>
        </div>
      <% end %>
      <% if @user_last_bet && @user_last_bet.amount == @hand_last_bet.amount %>
        <div class="check">
          <%= link_to "Check", game_hand_path(@game, @current_hand), method: :put, class: "action-button" %>
        </div>
        <% unless @hand_last_bet.amount == @game.max_bet_amount %>
          <div class="raise">
            <%= form_for [@game, @current_hand, @bet] do |f| %>
              <%= f.range_field :amount, min: @min_raise, max: @game.max_bet_amount, step: 1, value: @min_raise, id: 'amount', class: "betting-range #{"d-none" if @min_raise == @game.max_bet_amount}"%> <br>
              <%= f.submit "Raise to", class:"raise-button me-3" %>
              <div class="raise-amount"><span id="result"><%= @min_raise %></span><span>‚Ç¨</span></div>
            <% end %>
          </div>
        <% end %>
      <% elsif @hand_last_bet.amount > @current_hand.bets.first.amount || @current_hand.bets.count == 2 %>
        <div class="call <%= 'mt-3' if @hand_last_bet.amount == @game.max_bet_amount %>">
          <%= simple_form_for [@game, @current_hand, @bet] do |f| %>
            <%= f.input_field :amount, label: false, value: @hand_last_bet.amount, :as => :hidden %>
            <% if @user_last_bet %>
              <%= f.submit "Call #{@hand_last_bet.amount - @user_last_bet.amount}‚Ç¨", class:"action-button" %>
            <% else %>
              <%= f.submit "Call #{@hand_last_bet.amount}‚Ç¨", class:"action-button" %>
            <% end %>
          <% end %>
        </div>
        <% unless @hand_last_bet.amount == @game.max_bet_amount %>
          <div class="raise">
            <%= form_for [@game, @current_hand, @bet] do |f| %>
              <%= f.range_field :amount, min: @min_raise, max: @game.max_bet_amount, step: 1, value: @min_raise, id: 'amount', class: "betting-range #{"d-none" if @min_raise == @game.max_bet_amount}" %> <br>
              <%= f.submit "Raise to", class:"raise-button me-3" %>
              <div class="raise-amount"><span id="result"><%= @min_raise %></span><span>‚Ç¨</span></div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <% if !@current_hand_winners.empty? %>
    <div class="hand-winner">
      <% if @current_hand_winners.count == 1  %>
          <p><%= @current_hand_winners[0] %> wins the pot ! (<%= @pot %>‚Ç¨)</p>
      <% elsif @current_hand_winners.count == 2 %>
        <p><%= @current_hand_winners[0] %> and <%= @current_hand_winners[1] %> split the pot ! (<%= @pot %>‚Ç¨)</p>
      <% elsif @current_hand_winners.count == 3 %>
        <p><%= @current_hand_winners[0] %>, <%= @current_hand_winners[1] %> and <%= @current_hand_winners[2] %> split the pot ! (<%= @pot %>‚Ç¨)</p>
      <% elsif @current_hand_winners.count == 4 %>
        <p><%= @current_hand_winners[0] %>, <%= @current_hand_winners[1] %>, <%= @current_hand_winners[2] %> and <%= @current_hand_winners[3] %> split the pot ! (<%= @pot %>‚Ç¨)</p>
      <% elsif @current_hand_winners.count == 5 %>
        <p><%= @current_hand_winners[0] %>, <%= @current_hand_winners[1] %>, <%= @current_hand_winners[2] %>, <%= @current_hand_winners[3] %> and <%= @current_hand_winners[4] %> split the pot ! (<%= @pot %>‚Ç¨)</p>
      <% elsif @current_hand_winners.count == 6 %>
        <p><%= @current_hand_winners[0] %>, <%= @current_hand_winners[1] %>, <%= @current_hand_winners[2] %>, <%= @current_hand_winners[3] %>, <%= @current_hand_winners[4] %> and <%= @current_hand_winners[5] %> split the pot ! (<%= @pot %>‚Ç¨)</p>
      <% end %>
    </div>
  <% end %>
</div>
